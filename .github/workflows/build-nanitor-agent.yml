name: Build Nanitor Agent Package

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix and enable flakes
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_config: |
            experimental-features = nix-command flakes

      - name: Build nanitor-agent package
        run: |
          pwd
          ls -la
          nix build .#nanitor-agent --print-build-logs
      
      - name: Validate NixOS module
        run: |
          pwd
          ls -la
          mkdir -p temp-nixos-test
          cd temp-nixos-test
          cat <<'EOF' > flake.nix
          {
            description = "Temporary flake for NixOS module validation";
            inputs = {
              nixpkgs.url = "github:NixOS/nixpkgs/nixos-25.11";
              nanitorAgent.url = "path:../."; # parent of temp-nixos-test is repo root with your main flake
            };
            outputs = { self, nixpkgs, nanitorAgent, ... }: {
              nixosConfigurations.test = nixpkgs.lib.nixosSystem {
                system = "x86_64-linux";
                specialArgs = { inherit self; };
                modules = [
                  nanitorAgent.nixosModules.nanitor-agent
                  ({ config, lib, pkgs, ... }: {
                    boot.loader.systemd-boot.enable = lib.mkForce false;
                    boot.loader.grub.enable = lib.mkForce false;
                    networking.hostName = "test-nanitor-agent-module";
                    services.nanitor-agent.enable = true;
                  })
                ];
              };
            };
          }
          EOF
      
          nix build .#nixosConfigurations.test.config.system.build.toplevel --print-build-logs
